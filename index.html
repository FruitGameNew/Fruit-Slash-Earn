<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juicy Fruit Slash</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            overflow: hidden;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            position: relative;
        }

        #main-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            background: url('https://i.ibb.co/gMxrZN5R/peakpx-10.jpg') center/cover;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: transparent;
        }

        #score, #timer, #coins, #level {
            position: absolute;
            font-size: 28px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 50;
        }

        #score {
            top: 20px;
            left: 20px;
        }

        #timer {
            top: 20px;
            right: 20px;
        }

        #coins {
            bottom: 20px;
            left: 20px;
            font-size: 24px;
        }

        #level {
            bottom: 20px;
            right: 20px;
            font-size: 24px;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 40px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; /* বাটনগুলোর মধ্যে দূরত্ব কমানো হয়েছে */
        }

        #gameOver button {
            margin: 2px 0; /* বাটনগুলোর উপরে-নিচে মাত্র 2px দূরত্ব */
        }

        .hidden {
            display: none !important;
        }

        button {
            font-size: 24px;
            padding: 10px 20px;
            background-color: #FF4500;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            background-color: #FF6347;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        #startScreen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: url('https://i.ibb.co/gMxrZN5R/peakpx-10.jpg') center/cover;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 150;
            animation: fadeIn 1s ease-in-out;
        }

        #startScreen h1 {
            font-size: 60px;
            margin-bottom: 50px;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            animation: bounceIn 1.5s ease-out;
        }

        #startScreen button {
            min-width: 200px;
        }

        #history {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            color: #fff;
            font-size: 20px;
            max-height: 80%;
            width: 90%;
            max-width: 400px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 25px;
            border-radius: 15px;
            cursor: default;
            text-align: center;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            border: 2px solid #FFD700;
            animation: slideInUp 0.8s ease-out;
        }

        #history h3 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        #history button {
            margin-top: 20px;
        }

        .ad-container {
            margin: 5px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 50px;
            overflow: hidden;
        }

        /* Congratulations message style */
        #congratsMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 30px;
            background-color: rgba(46, 139, 87, 0.9); /* SeaGreen with opacity */
            color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.7); /* Green glow */
            z-index: 200;
            animation: fadeInScale 0.8s ease-out forwards;
            border: 3px solid #ADFF2F; /* GreenYellow border */
        }

        #shopScreen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: url('https://i.ibb.co/gMxrZN5R/peakpx-10.jpg') center/cover;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 170;
            animation: fadeIn 1s ease-in-out;
            padding: 20px;
            box-sizing: border-box;
        }

        #shopScreen h2 {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        #shopItems {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            max-height: 60%;
            overflow-y: auto;
            width: 90%;
            max-width: 800px;
        }

        .shop-item {
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            width: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            transition: transform 0.2s;
        }

        .shop-item:hover {
            transform: translateY(-5px);
        }

        .shop-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .shop-item h4 {
            margin: 5px 0;
            font-size: 20px;
            color: #ADD8E6; /* LightBlue */
        }

        .shop-item p {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .shop-item .price {
            color: #ADFF2F; /* GreenYellow */
            font-weight: bold;
            font-size: 18px;
        }

        .shop-item button {
            font-size: 18px;
            padding: 8px 15px;
            margin-top: 10px;
            width: 100%;
        }

        .shop-item button.equipped {
            background-color: #32CD32; /* LimeGreen */
            cursor: default;
        }

        .shop-item button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        #claimRewardButton {
            background-color: #4CAF50; /* Green */
            color: white;
            font-size: 28px;
            padding: 15px 30px;
            margin-top: 20px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        #claimRewardButton:hover {
            background-color: #45a049;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        @keyframes slideInUp {
            from { transform: translate(-50%, 150%); opacity: 0; }
            to { transform: translate(-50%, 50%); opacity: 1; }
        }

        /* New keyframes for congratulatory message */
        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Floating text animation */
        @keyframes floatUpAndFade {
            0% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -100px); }
        }
    </style>
</head>
<body>
    <div id="main-wrapper">
        <div id="startScreen">
            <h1>Juicy Fruit Slash</h1>
            <button id="startGameButton">Start Game</button>
            <button id="soundToggle">Sound: On</button>
            <button id="shopButton">Shop</button>
            <button id="historyButton">More Coming soon</button>
            <button id="historyButton"> NFT Soon </button>
            <button id="historyButton"> Quick enable: Playtime rewards </button>



            <div class="ad-container">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '2e0a73dd91c6951fdc75e67a2667a1f1',
                        'format' : 'iframe',
                        'height' : 50,
                        'width' : 320,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/2e0a73dd91c6951fdc75e67a2667a1f1/invoke.js"></script>
            </div>

            <div class="ad-container">
                <script type='text/javascript' src='//pl26891336.profitableratecpm.com/80/4e/6e/804e6ebb2cf1ddf6ab2b24885c6d0049.js'></script>
                <script async="async" data-cfasync="false" src="//pl26891340.profitableratecpm.com/63d0b0ecb94c5c55f7380152ba730281/invoke.js"></script>
                <div id="container-63d0b0ecb94c5c55f7380152ba730281"></div>
            </div>
        </div>

        <div id="game-container" class="hidden">
            <canvas id="gameCanvas"></canvas>
            <div id="score">Score: <span id="scoreValue">0</span></div>
            <div id="timer">Time: <span id="timeValue">60</span></div>
            <div id="coins">Coins: <span id="coinsValue">0</span></div>
            <div id="level">Level: <span id="levelValue">1</span></div>

            <div id="gameOver" class="hidden">
                Game Over!<br>
                Final Score: <span id="finalScore"></span><br>

                <div class="ad-container">
                    <script type="text/javascript">
                        atOptions = {
                            'key' : '2e0a73dd91c6951fdc75e67a2667a1f1',
                            'format' : 'iframe',
                            'height' : 50,
                            'width' : 320,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/2e0a73dd91c6951fdc75e67a2667a1f1/invoke.js"></script>
                </div>

                <button id="backToMainFromGameOver">Back to Menu</button>
                <button id="claimRewardButton" class="hidden"></button>
                <p style="font-size: 18px; color: #fff; margin-top: 15px;">
                    To verify, please send a screenshot of your final score to us on WhatsApp!
                </p>

                <div class="ad-container">
                    <script type='text/javascript' src='//pl26891336.profitableratecpm.com/80/4e/6e/804e6ebb2cf1ddf6ab2b24885c6d0049.js'></script>
                    <script async="async" data-cfasync="false" src="//pl26891340.profitableratecpm.com/63d0b0ecb94c5c55f7380152ba730281/invoke.js"></script>
                    <div id="container-63d0b0ecb94c5c55f7380152ba730281"></div>
                </div>
            </div>
        </div>

        <div id="history" class="hidden">
            <h3>High Scores</h3>
            <p id="historyContent"></p>
            <button id="historyButton"> Airdrop Rewards Enable Soon</button>
            <button id="backToMainFromHistory">Back to Main Menu</button>
        </div>

        <div id="shopScreen" class="hidden">
            <h2>Shop</h2>
            <div id="shopItems">
                </div>
            <button id="backToMainFromShop">Back to Main Menu</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('scoreValue');
        const timeElement = document.getElementById('timeValue');
        const coinsElement = document.getElementById('coinsValue');
        const levelElement = document.getElementById('levelValue');
        const gameOverElement = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const gameContainer = document.getElementById('game-container');

        const startScreenElement = document.getElementById('startScreen');
        const startGameButton = document.getElementById('startGameButton');
        const soundToggleButton = document.getElementById('soundToggle');
        const shopButton = document.getElementById('shopButton');
        const historyButton = document.getElementById('historyButton');
        const historyElement = document.getElementById('history');
        const historyContentElement = document.getElementById('historyContent');
        const backToMainFromGameOverButton = document.getElementById('backToMainFromGameOver');
        const backToMainFromHistoryButton = document.getElementById('backToMainFromHistory');
        const shopScreenElement = document.getElementById('shopScreen');
        const shopItemsContainer = document.getElementById('shopItems');
        const backToMainFromShopButton = document.getElementById('backToMainFromShop');
        const claimRewardButton = document.getElementById('claimRewardButton');

        // আপনার WhatsApp ফোন নম্বর এখানে যোগ করুন (যেমন: 8801XXXXXXXXX)
        const YOUR_PHONE_NUMBER = '8801700511339'; // আপনার ফোন নম্বর দিন

        // স্কোর সহ WhatsApp লিংক তৈরি করার জন্য ফাংশন
     function getWhatsappLink(rewardAmount) {
    let message = `Hello! I just played Juicy Fruit Slash and achieved a score of ${score} at Level ${playerLevel}. I'd like to claim my $${rewardAmount} reward!`;
    return `https://wa.me/${YOUR_PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
}

        function resizeCanvas() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }

        let score = 0;
        let timeLeft = 40;
        let gameObjects = [];
        let particles = [];
        let isGameOver = false;
        let lastSpawnTime = 0;
        let spawnInterval = 200;
        let isSoundOn = true;
        let gameTimerInterval;
        let animationFrameId;
        let playerCoins = parseInt(localStorage.getItem('playerCoins') || '0');
        let playerLevel = parseInt(localStorage.getItem('playerLevel') || '1');
        let currentCombo = 0;
        let lastSliceTime = 0;
        const comboTimeLimit = 500; // ms to maintain combo
        let activePowerUps = {
            slowMotion: false,
            multiplier: 1,
            invincible: false
        };
        let equippedBlade = localStorage.getItem('equippedBlade') || 'default'; // default blade

        const objectTypes = [
            {
                type: 'fruit',
                name: 'Watermelon',
                color: '#8B4513',
                juiceColor: '#FF1493',
                image: 'https://i.ibb.co/5g6fBvnd/1000066501-removebg-preview.png',
                points: 5,
                coinDrop: 1
            },
            {
                type: 'fruit',
                name: 'Apple',
                color: '#FF0000',
                juiceColor: '#FF4500',
                image: 'https://i.ibb.co/TDyKkhhv/20250610-221601.png',
                points: 5,
                coinDrop: 1
            },
            {
                type: 'fruit',
                name: 'Orange',
                color: '#FFA500',
                juiceColor: '#FF8C00',
                image: 'https://i.ibb.co/1Yh9d4fD/1000066502-removebg-preview.png',
                points: 5,
                coinDrop: 1
            },
            {
                type: 'fruit',
                name: 'Pineapple',
                color: '#FFD700',
                juiceColor: '#EEE8AA',
                image: 'https://i.ibb.co/V0NJ3ggR/20250612-131415.png',
                points: 5,
                coinDrop: 1
            },
            {
                type: 'fruit',
                name: 'Strawberry',
                color: '#FF6347',
                juiceColor: '#DC143C',
                image: 'https://i.ibb.co/4wSkwt2Q/20250612-131341.png',
                points: 5,
                coinDrop: 1
            },
            // Special Fruits
            {
                type: 'powerup',
                name: 'Freeze Fruit',
                color: '#87CEEB',
                juiceColor: '#ADD8E6',
                image: 'https://i.ibb.co/tTPDh0Dt/20250612-135631.png', // Placeholder, replace with actual image
                points: 5,
                effect: 'freeze',
                duration: 3000 // 3 seconds
            },
            {
                type: 'powerup',
                name: 'Multiplier Fruit',
                color: '#DAA520',
                juiceColor: '#FFD700',
                image: 'https://i.ibb.co/Tqdkdmz1/20250612-135822.png', // Placeholder, replace with actual image
                points: 7,
                effect: 'multiplier',
                multiplier: 2,
                duration: 5000 // 5 seconds
            },
            // Bombs
            {
                type: 'bomb',
                name: 'Bomb',
                color: '#333333',
                juiceColor: '#FF0000',
                image: 'https://i.ibb.co/GQzjJMXh/20250612-131328.png',
                points: -50,
                effect: 'standard_bomb'
            },
            {
                type: 'bomb',
                name: 'Smoke Bomb',
                color: '#696969',
                juiceColor: '#A9A9A9',
                image: 'https://i.ibb.co/GQzjJMXh/20250612-131328.png', // Placeholder, replace with actual image
                points: -20,
                effect: 'smoke_screen'
            }
        ];

        const shopItems = [
            {
                id: 'blade_fire',
                name: 'Fire Blade',
                type: 'blade',
                price: 100,
                image: 'https://i.ibb.co/fzFJm8bZ/20250612-140048.png', // Placeholder image
                description: 'Ignite your scores!',
                unlocked: false // Will be updated from localStorage
            },
            {
                id: 'blade_ice',
                name: 'Ice Blade',
                type: 'blade',
                price: 150,
                image: 'https://i.ibb.co/m5ZXRtZ0/20250612-135948.png', // Placeholder image
                description: 'Freeze the competition!',
                unlocked: false
            },
            {
                id: 'powerup_shield',
                name: 'Bomb Shield (1 game)',
                type: 'powerup',
                price: 50,
                image: 'https://i.ibb.co/GQzjJMXh/20250612-131328.png', // Placeholder image
                description: 'Protects from 1 bomb hit.',
                unlocked: false, // Power-ups are generally "bought" rather than unlocked
                consumable: true,
                effect: 'shield_one_game'
            }
        ];

        let purchasedItems = JSON.parse(localStorage.getItem('purchasedItems') || '[]');

        const objectImages = {};
        let imagesLoadedCount = 0;
        let totalImages = objectTypes.length;

        // Load images for game objects
        objectTypes.forEach(obj => {
            const img = new Image();
            img.src = obj.image;
            img.onload = () => {
                imagesLoadedCount++;
                if (imagesLoadedCount === totalImages) {
                    console.log('All game object images loaded.');
                }
            };
            img.onerror = () => {
                console.warn(`Failed to load image: ${obj.image}`);
                imagesLoadedCount++;
            };
            objectImages[obj.name] = img;
        });

        // Load images for shop items
        shopItems.forEach(item => {
            const img = new Image();
            img.src = item.image;
            img.onload = () => {
                // No specific counter needed for shop images, as they load independently
            };
            img.onerror = () => {
                console.warn(`Failed to load shop image: ${item.image}`);
            };
            objectImages[item.id] = img; // Use item.id as key for shop images
        });


        const sliceSound = new Audio('https://www.soundjay.com/buttons/sounds/button-1.mp3');
        const bombSound = new Audio('https://www.soundjay.com/misc/sounds/bomb-explosion-01.mp3');
        const powerupSound = new Audio('https://www.soundjay.com/misc/sounds/powerup.mp3');
        const comboSound = new Audio('https://www.soundjay.com/misc/sounds/ding.mp3'); // For combo achievements

        class GameObject {
            constructor(objType) {
                this.type = objType.type;
                this.name = objType.name;
                this.color = objType.color;
                this.juiceColor = objType.juiceColor;
                this.image = objectImages[this.name];
                this.points = objType.points;
                this.coinDrop = objType.coinDrop || 0;
                this.effect = objType.effect;
                this.duration = objType.duration;
                this.multiplier = objType.multiplier;

                this.x = Math.random() * (canvas.width - 60) + 30;
                this.y = canvas.height + 50;
                this.radius = 30 + Math.random() * 10;
                this.speedX = (Math.random() - 0.5) * 7;
                this.speedY = -(Math.random() * 8 + 10);
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.1;
                this.isSliced = false;
                this.slicedTime = 0; // For bomb effect duration
            }

            update() {
                // Apply slow motion effect if active
                const speedModifier = activePowerUps.slowMotion ? 0.3 : 1;
                this.x += this.speedX * speedModifier;
                this.y += this.speedY * speedModifier;
                this.speedY += 0.15 * speedModifier;
                this.rotation += this.rotationSpeed * speedModifier;

                if (this.isSliced && this.effect === 'smoke_screen') {
                    // Reduce opacity of smoke bomb over time
                    const elapsed = Date.now() - this.slicedTime;
                    const fadeDuration = 1000; // Smoke fades in 1 second
                    if (elapsed < fadeDuration) {
                        ctx.globalAlpha = 1 - (elapsed / fadeDuration);
                    } else {
                        ctx.globalAlpha = 0; // Fully transparent
                    }
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                if (this.image && this.image.complete && this.image.naturalWidth > 0 && !this.isSliced) {
                    ctx.drawImage(this.image, -this.radius, -this.radius, this.radius * 2, this.radius * 2);
                } else if (!this.isSliced) { // Draw fallback circle if image isn't loaded/sliced
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    ctx.closePath();
                } else if (this.isSliced && this.type === 'fruit') { // Draw sliced fruit effect
                     ctx.beginPath();
                     ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                     ctx.fillStyle = this.juiceColor;
                     ctx.fill();
                     ctx.closePath();
                     ctx.beginPath();
                     ctx.moveTo(-this.radius, 0);
                     ctx.lineTo(this.radius, 0);
                     ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                     ctx.lineWidth = 5;
                     ctx.stroke();
                }

                // Draw smoke screen if active
                if (this.isSliced && this.effect === 'smoke_screen') {
                    const elapsed = Date.now() - this.slicedTime;
                    const displayDuration = 3000; // Smoke visible for 3 seconds
                    if (elapsed < displayDuration) {
                        ctx.globalAlpha = 0.5 * (1 - (elapsed / displayDuration)); // Fade out effect
                        ctx.beginPath();
                        ctx.arc(0, 0, canvas.width / 2, 0, Math.PI * 2); // Large semi-transparent circle
                        ctx.fillStyle = 'rgba(105, 105, 105, 0.7)'; // DimGray
                        ctx.fill();
                        ctx.closePath();
                    } else {
                        // Remove smoke effect after duration
                        activePowerUps.smokeScreen = false;
                        this.isSliced = false; // To stop drawing this object
                    }
                }

                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 8 + 3;
                this.speedX = (Math.random() - 0.5) * 12;
                this.speedY = (Math.random() - 0.5) * 12;
                this.color = color;
                this.alpha = 1;
                this.gravity = 0.2;
                this.life = 100 + Math.random() * 50;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += this.gravity;
                this.alpha -= 1 / this.life;
                this.size *= 0.99;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();
                ctx.restore();
            }
        }

        function spawnObject() {
            const now = Date.now();
            // Adjust spawn interval based on level
            const baseSpawnInterval = 200;
            const levelFactor = Math.max(0, 1 - (playerLevel * 0.02)); // Faster spawning at higher levels
            const currentSpawnInterval = baseSpawnInterval * levelFactor;

            if (!isGameOver && now - lastSpawnTime > currentSpawnInterval && gameObjects.length < 30) {
                let availableObjects = objectTypes.slice();

                // Increase bomb probability at higher levels
                let bombProbability = 0.15 + (playerLevel * 0.01);
                bombProbability = Math.min(0.3, bombProbability); // Cap bomb probability

                // Randomly select an object
                let chosenType;
                if (Math.random() < bombProbability) {
                    // Select a bomb type (standard or smoke)
                    const bombTypes = objectTypes.filter(obj => obj.type === 'bomb');
                    chosenType = bombTypes[Math.floor(Math.random() * bombTypes.length)];
                } else if (Math.random() < 0.1) { // 10% chance for a power-up fruit
                    const powerupTypes = objectTypes.filter(obj => obj.type === 'powerup');
                    chosenType = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
                } else {
                    // Select a normal fruit
                    const fruitTypes = objectTypes.filter(obj => obj.type === 'fruit');
                    chosenType = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                }

                const newObject = new GameObject(chosenType);
                gameObjects.push(newObject);
                lastSpawnTime = now;
            }
        }

        function handleInput(e) {
            if (isGameOver) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const touchX = (clientX - rect.left) * scaleX;
            const touchY = (clientY - rect.top) * scaleY;

            let slicedThisFrame = false;

            gameObjects = gameObjects.filter(obj => {
                const dx = obj.x - touchX;
                const dy = obj.y - touchY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < obj.radius && !obj.isSliced) {
                    obj.isSliced = true;
                    slicedThisFrame = true;

                    if (obj.type === 'fruit') {
                        const pointsGained = obj.points * activePowerUps.multiplier;
                        score += pointsGained;
                        playerCoins += obj.coinDrop;
                        createParticles(obj.x, obj.y, obj.juiceColor);
                        if (isSoundOn) {
                            sliceSound.currentTime = 0;
                            sliceSound.play();
                        }
                        currentCombo++;
                        lastSliceTime = Date.now();
                        checkCombo();
                        showFloatingText(`+${pointsGained}`, '#ADFF2F', 1000, 'points', obj.x, obj.y); // Show points for fruit
                    } else if (obj.type === 'bomb') {
                        if (activePowerUps.invincible) {
                            // Bomb shield protected
                            console.log("Bomb hit but shielded!");
                            createParticles(obj.x, obj.y, 'rgba(0, 0, 255, 0.5)'); // Blue particles for shield hit
                            if (isSoundOn) {
                                powerupSound.currentTime = 0;
                                powerupSound.play();
                            }
                            activePowerUps.invincible = false; // Shield used
                            let shieldIndex = purchasedItems.findIndex(item => item.id === 'powerup_shield' && item.quantity > 0);
                            if (shieldIndex !== -1) {
                                purchasedItems[shieldIndex].quantity--;
                                localStorage.setItem('purchasedItems', JSON.stringify(purchasedItems));
                            }
                            showFloatingText(`Shield Used!`, 'cyan', 1500, 'info', obj.x, obj.y); // Indicate shield use
                        } else {
                            const pointsLost = Math.abs(Math.floor(obj.points / 2)); // Points are negative, so make them positive for display
                            score = Math.floor(score / 2);
                            createParticles(obj.x, obj.y, obj.juiceColor, true);
                            if (isSoundOn) {
                                bombSound.currentTime = 0;
                                bombSound.play();
                            }
                            currentCombo = 0; // Break combo on bomb hit
                            showFloatingText(`-${pointsLost}`, '#FF4500', 1000, 'points', obj.x, obj.y); // Show points lost for bomb
                        }

                        if (obj.effect === 'smoke_screen') {
                            obj.slicedTime = Date.now();
                            activePowerUps.smokeScreen = true;
                            // Optionally show a message for smoke bomb effect
                            showFloatingText('Smoke Screen!', 'gray', 1500, 'info', obj.x, obj.y - 50);
                        } else if (obj.effect === 'standard_bomb') {
                            // Standard bomb effect (score reduction) already handled
                        }
                    } else if (obj.type === 'powerup') {
                        if (isSoundOn) {
                            powerupSound.currentTime = 0;
                            powerupSound.play();
                        }
                        activatePowerUp(obj.effect, obj.duration, obj.multiplier);
                        score += obj.points;
                        showFloatingText(`+${obj.points} ${obj.name.replace('Fruit', '')}!`, '#ADD8E6', 1500, 'powerup', obj.x, obj.y); // Show points and power-up name
                    }

                    scoreElement.textContent = score;
                    coinsElement.textContent = playerCoins;
                    return false; // Remove sliced object
                }
                return true;
            });

            if (!slicedThisFrame && (Date.now() - lastSliceTime > comboTimeLimit)) {
                currentCombo = 0; // Reset combo if no slice within time limit
            }
        }

        function createParticles(x, y, color, isBomb = false) {
            let numParticles = isBomb ? 50 : 25;
            for (let i = 0; i < numParticles; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function activatePowerUp(effect, duration, value) {
            switch (effect) {
                case 'freeze':
                    activePowerUps.slowMotion = true;
                    setTimeout(() => {
                        activePowerUps.slowMotion = false;
                    }, duration);
                    break;
                case 'multiplier':
                    activePowerUps.multiplier = value;
                    setTimeout(() => {
                        activePowerUps.multiplier = 1;
                    }, duration);
                    break;
                case 'shield_one_game':
                    activePowerUps.invincible = true;
                    // This power-up is consumed on use, no timeout needed here.
                    break;
                // Add more power-up effects as needed
            }
            console.log(`Power-up activated: ${effect}`);
        }

        function checkCombo() {
            if (currentCombo > 1) {
                let bonus = 0;
                let comboMessage = '';
                if (currentCombo === 3) { bonus = 10; comboMessage = 'Good Combo!'; }
                else if (currentCombo === 5) { bonus = 25; comboMessage = 'Great Combo!'; }
                else if (currentCombo === 10) { bonus = 50; comboMessage = 'Super Combo!'; }
                else if (currentCombo >= 15) { bonus = 100; comboMessage = 'Unbelievable Combo!'; }

                if (bonus > 0) {
                    score += bonus;
                    scoreElement.textContent = score;
                    if (isSoundOn) {
                        comboSound.currentTime = 0;
                        comboSound.play();
                    }
                    showFloatingText(`+${bonus} ${comboMessage}`, 'yellow', 2000, 'combo');
                }
            }
        }

        function showFloatingText(text, color, duration, type, x = canvas.width / 2, y = canvas.height / 2) {
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            tempDiv.style.position = 'absolute';
            tempDiv.style.color = color;
            tempDiv.style.fontSize = type === 'combo' ? '36px' : '28px';
            tempDiv.style.fontWeight = 'bold';
            tempDiv.style.textShadow = '2px 2px 4px rgba(0,0,0,0.7)';
            tempDiv.style.zIndex = '200';
            tempDiv.style.pointerEvents = 'none'; // Make it not interfere with clicks
            tempDiv.style.animation = `floatUpAndFade ${duration / 1000}s forwards`;

            // Position near the sliced object
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            tempDiv.style.left = `${(x / scaleX) + rect.left}px`;
            tempDiv.style.top = `${(y / scaleY) + rect.top}px`;
            tempDiv.style.transform = 'translate(-50%, -50%)'; // Center the text horizontally

            document.body.appendChild(tempDiv);

            setTimeout(() => {
                tempDiv.remove();
            }, duration);

            // Add CSS keyframes for the animation dynamically (ensure this is only added once)
            // This part was already handled and should be fine as is, but ensure it's not repeatedly added.
            if (!document.getElementById('floatUpAndFadeKeyframes')) {
                const styleSheet = document.createElement('style');
                styleSheet.id = 'floatUpAndFadeKeyframes';
                styleSheet.innerHTML = `
                    @keyframes floatUpAndFade {
                        0% { opacity: 1; transform: translate(-50%, 0); }
                        100% { opacity: 0; transform: translate(-50%, -100px); }
                    }
                `;
                document.head.appendChild(styleSheet);
            }
        }


        function startTimer() {
            clearInterval(gameTimerInterval); // Clear any existing timer
            gameTimerInterval = setInterval(() => {
                if (isGameOver) {
                    clearInterval(gameTimerInterval);
                    return;
                }
                timeLeft--;
                timeElement.textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            isGameOver = true;
            finalScoreElement.textContent = score;
            gameOverElement.classList.remove('hidden');
            clearInterval(gameTimerInterval);
            cancelAnimationFrame(animationFrameId); // Stop the game loop animation

            playerCoins += Math.floor(score / 10); // Earn coins based on score
            localStorage.setItem('playerCoins', playerCoins);
            coinsElement.textContent = playerCoins;

            checkLevelUp(); // Check if player leveled up
            displayRewardButton(); // Check and display reward button
        }

        function displayRewardButton() {
            claimRewardButton.classList.add('hidden'); // Hide by default
            if (score >= 1000) {
                claimRewardButton.textContent = 'Claim Reward: $0.5';
                claimRewardButton.onclick = () => window.open(getWhatsappLink(0.5), '_blank');
                claimRewardButton.classList.remove('hidden');
            } else if (score >= 700) {
                claimRewardButton.textContent = 'Claim Reward: $0.2';
                claimRewardButton.onclick = () => window.open(getWhatsappLink(0.2), '_blank');
                claimRewardButton.classList.remove('hidden');
            }
        }

        function checkLevelUp() {
            const requiredScoreForNextLevel = playerLevel * 1000; // Example: Level 1 -> 1000, Level 2 -> 2000
            if (score >= requiredScoreForNextLevel) {
                playerLevel++;
                localStorage.setItem('playerLevel', playerLevel);
                levelElement.textContent = playerLevel;
                showFloatingText(`LEVEL UP! Level ${playerLevel}`, '#ADFF2F', 3000); // GreenYellow
            }
        }


        function displayCongratulations() {
            const congratsMessage = document.createElement('div');
            congratsMessage.id = 'congratsMessage';
            congratsMessage.innerHTML = '<h2>অভিনন্দন!</h2><p>আপনি ৫০০+ স্কোর করেছেন!</p>'; // Bengali text for congratulations
            document.body.appendChild(congratsMessage);

            // Automatically remove the message after a few seconds
            setTimeout(() => {
                if (congratsMessage.parentNode) { // Check if it's still in the DOM
                    congratsMessage.remove();
                }
            }, 4000); // Message disappears after 4 seconds
        }


        function saveScore() {
            let playerName = prompt("Enter your name:", "Player");
            if (playerName && playerName.trim() !== "") {
                playerName = playerName.trim();
                let history = JSON.parse(localStorage.getItem('fruitSlashHistory') || '[]');
                history.push({
                    name: playerName,
                    score: score,
                    date: new Date().toLocaleDateString('en-GB')
                });
                history.sort((a, b) => b.score - a.score);
                history = history.slice(0, 5);
                localStorage.setItem('fruitSlashHistory', JSON.stringify(history));
                updateHistory();
            } else {
                alert("Please enter a valid name to save your score.");
            }
        }

        function updateHistory() {
            let history = JSON.parse(localStorage.getItem('fruitSlashHistory') || '[]');
            const historyContent = history.map((entry, index) =>
                `${index + 1}. ${entry.name}: ${entry.score} (${entry.date || 'Unknown'})`
            ).join('<br>');
            historyContentElement.innerHTML = history.length === 0 ? 'No scores yet!' : historyContent;
        }

        function restartGame() {
            // Clear any lingering animation frames and intervals
            cancelAnimationFrame(animationFrameId);
            clearInterval(gameTimerInterval);

            score = 0;
            timeLeft = 60;
            gameObjects = [];
            particles = [];
            isGameOver = false;
            lastSpawnTime = 0;
            currentCombo = 0; // Reset combo
            lastSliceTime = 0; // Reset last slice time
            activePowerUps = { // Reset all power-ups
                slowMotion: false,
                multiplier: 1,
                invincible: false
            };

            scoreElement.textContent = score;
            timeElement.textContent = timeLeft;
            coinsElement.textContent = playerCoins;
            levelElement.textContent = playerLevel;
            gameOverElement.classList.add('hidden');
            claimRewardButton.classList.add('hidden'); // Hide claim button on restart

            // Ensure the congratulations message is removed if it's present
            const existingCongratsMessage = document.getElementById('congratsMessage');
            if (existingCongratsMessage) {
                existingCongratsMessage.remove();
            }

            // Check for consumable power-ups purchased for this game
            const shieldPowerUp = purchasedItems.find(item => item.id === 'powerup_shield' && item.quantity > 0);
            if (shieldPowerUp) {
                activePowerUps.invincible = true; // Activate shield if purchased for this game
                console.log("Shield activated for this game!");
            }

            startTimer();
            gameLoop(); // Start the game loop again
        }

        function gameLoop() {
            if (isGameOver || gameContainer.classList.contains('hidden')) {
                cancelAnimationFrame(animationFrameId); // Ensure loop stops if game ends or hidden
                return;
            }
            ctx.fillStyle = 'rgba(0, 0, 0, 0.14)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            gameObjects.forEach(obj => {
                obj.update();
                obj.draw();
            });
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });
            gameObjects = gameObjects.filter(obj => {
                return obj.y < canvas.height + obj.radius * 2 &&
                       obj.y > -canvas.height * 0.2 &&
                       obj.x > -obj.radius * 2 &&
                       obj.x < canvas.width + obj.radius * 2 &&
                       !(obj.isSliced && obj.effect === 'smoke_screen' && (Date.now() - obj.slicedTime > 3000)); // Remove smoke bomb after its effect
            });
            particles = particles.filter(particle => particle.alpha > 0);
            spawnObject();
            animationFrameId = requestAnimationFrame(gameLoop); // Store the ID
        }

        function handleStartGame() {
            startScreenElement.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resizeCanvas();
            restartGame(); // Use restartGame to initialize the game
            // gameLoop() is now called inside restartGame()
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            soundToggleButton.textContent = `Sound: ${isSoundOn ? 'On' : 'Off'}`;
            if (isSoundOn) {
                sliceSound.currentTime = 0;
                sliceSound.play();
            }
        }

        function showHighScores() {
            startScreenElement.classList.add('hidden');
            historyElement.classList.remove('hidden');
            updateHistory();
        }

        function backToMainMenuFromHistory() {
            historyElement.classList.add('hidden');
            startScreenElement.classList.remove('hidden');
        }

        function backToMainMenuFromShop() {
            shopScreenElement.classList.add('hidden');
            startScreenElement.classList.remove('hidden');
        }

        function backToMainMenuFromGameOver() {
            // Clear any lingering animation frames and intervals
            cancelAnimationFrame(animationFrameId);
            clearInterval(gameTimerInterval);

            gameOverElement.classList.add('hidden');
            gameContainer.classList.add('hidden');
            startScreenElement.classList.remove('hidden');

            // Reset game state when returning to main menu
            score = 0;
            timeLeft = 60;
            gameObjects = [];
            particles = [];
            isGameOver = false;
            lastSpawnTime = 0;
            currentCombo = 0;
            lastSliceTime = 0;
            activePowerUps = {
                slowMotion: false,
                multiplier: 1,
                invincible: false
            };
            claimRewardButton.classList.add('hidden'); // Hide claim button when returning to main menu

            // Ensure the congratulations message is removed if it's present
            const existingCongratsMessage = document.getElementById('congratsMessage');
            if (existingCongratsMessage) {
                existingCongratsMessage.remove();
            }
        }

        function showShop() {
            startScreenElement.classList.add('hidden');
            shopScreenElement.classList.remove('hidden');
            renderShopItems();
        }

        function renderShopItems() {
            shopItemsContainer.innerHTML = '';
            shopItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('shop-item');
                itemDiv.innerHTML = `
                    <img src="${objectImages[item.id] ? objectImages[item.id].src : ''}" alt="${item.name}">
                    <h4>${item.name}</h4>
                    <p>${item.description}</p>
                    <p class="price">Price: ${item.price} Coins</p>
                    <button id="buy_${item.id}" ${purchasedItems.some(p => p.id === item.id) && item.type === 'blade' ? 'class="equipped"' : ''}>
                        ${purchasedItems.some(p => p.id === item.id && p.quantity > 0) && item.type === 'powerup' ? `Use (${purchasedItems.find(p => p.id === item.id).quantity})` :
                           (purchasedItems.some(p => p.id === item.id) && item.type === 'blade' ? 'Equipped' :
                           'Buy')}
                    </button>
                `;
                shopItemsContainer.appendChild(itemDiv);

                const buyButton = itemDiv.querySelector(`#buy_${item.id}`);
                if (item.type === 'blade') {
                    if (equippedBlade === item.id) {
                        buyButton.textContent = 'Equipped';
                        buyButton.disabled = true;
                        buyButton.classList.add('equipped');
                    } else if (purchasedItems.some(p => p.id === item.id)) {
                        buyButton.textContent = 'Equip';
                        buyButton.disabled = false;
                        buyButton.classList.remove('equipped');
                    } else {
                        buyButton.disabled = (playerCoins < item.price);
                    }
                } else if (item.type === 'powerup') {
                    const purchasedPowerUp = purchasedItems.find(p => p.id === item.id);
                    if (purchasedPowerUp && purchasedPowerUp.quantity > 0) {
                        buyButton.textContent = `Use (${purchasedPowerUp.quantity})`;
                    } else {
                        buyButton.textContent = 'Buy';
                        buyButton.disabled = (playerCoins < item.price);
                    }
                }

                buyButton.onclick = () => handleShopPurchase(item);
            });
        }

        function handleShopPurchase(item) {
            if (item.type === 'blade') {
                const alreadyPurchased = purchasedItems.some(p => p.id === item.id);

                if (!alreadyPurchased && playerCoins >= item.price) {
                    playerCoins -= item.price;
                    purchasedItems.push({ id: item.id, type: item.type, quantity: 1 });
                    localStorage.setItem('playerCoins', playerCoins);
                    localStorage.setItem('purchasedItems', JSON.stringify(purchasedItems));
                    equippedBlade = item.id;
                    localStorage.setItem('equippedBlade', equippedBlade);
                    coinsElement.textContent = playerCoins;
                    renderShopItems();
                    showFloatingText(`You bought ${item.name}!`, '#ADFF2F', 2000);
                } else if (alreadyPurchased && equippedBlade !== item.id) {
                    equippedBlade = item.id;
                    localStorage.setItem('equippedBlade', equippedBlade);
                    renderShopItems();
                    showFloatingText(`Equipped ${item.name}!`, '#ADD8E6', 2000);
                } else if (alreadyPurchased && equippedBlade === item.id) {
                    // Already equipped, do nothing
                } else {
                    alert("Not enough coins!");
                }
            } else if (item.type === 'powerup') {
                const existingPowerUp = purchasedItems.find(p => p.id === item.id);
                if (existingPowerUp && existingPowerUp.quantity > 0) {
                    // Use power-up (if it's a consumable)
                    if (item.consumable) {
                        activatePowerUp(item.effect, item.duration, item.multiplier);
                        existingPowerUp.quantity--;
                        localStorage.setItem('purchasedItems', JSON.stringify(purchasedItems));
                        showFloatingText(`Used ${item.name}!`, '#ADD8E6', 2000);
                        renderShopItems(); // Update button text
                    }
                } else if (playerCoins >= item.price) {
                    // Buy power-up
                    playerCoins -= item.price;
                    if (existingPowerUp) {
                        existingPowerUp.quantity = (existingPowerUp.quantity || 0) + 1;
                    } else {
                        purchasedItems.push({ id: item.id, type: item.type, quantity: 1 });
                    }
                    localStorage.setItem('playerCoins', playerCoins);
                    localStorage.setItem('purchasedItems', JSON.stringify(purchasedItems));
                    coinsElement.textContent = playerCoins;
                    showFloatingText(`Bought ${item.name}!`, '#ADFF2F', 2000);
                    renderShopItems();
                } else {
                    alert("Not enough coins!");
                }
            }
        }


        canvas.addEventListener('click', handleInput);
        canvas.addEventListener('touchstart', handleInput);
        canvas.addEventListener('touchmove', handleInput);
        startGameButton.addEventListener('click', handleStartGame);
        soundToggleButton.addEventListener('click', toggleSound);
        historyButton.addEventListener('click', showHighScores);
        shopButton.addEventListener('click', showShop);
        backToMainFromHistoryButton.addEventListener('click', backToMainMenuFromHistory);
        backToMainFromGameOverButton.addEventListener('click', backToMainMenuFromGameOver);
        backToMainFromShopButton.addEventListener('click', backToMainMenuFromShop);


        document.addEventListener('DOMContentLoaded', () => {
            gameContainer.classList.add('hidden');
            gameOverElement.classList.add('hidden');
            historyElement.classList.add('hidden');
            shopScreenElement.classList.add('hidden'); // Hide shop initially
            soundToggleButton.textContent = `Sound: ${isSoundOn ? 'On' : 'Off'}`;
            coinsElement.textContent = playerCoins;
            levelElement.textContent = playerLevel;
            updateHistory();
            renderShopItems(); // Initialize shop display
            claimRewardButton.classList.add('hidden'); // Ensure claim button is hidden on initial load
        });
    </script>
</body>
</html>